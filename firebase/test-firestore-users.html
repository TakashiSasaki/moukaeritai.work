<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Firestore Users Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px;
      line-height: 1.4;
    }
    button {
      padding: 8px 14px;
      margin-right: 8px;
      cursor: pointer;
      margin-bottom: 8px;
    }
    pre {
      background: #f6f8fa;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      overflow: auto;
    }
    .ok { color: #0f766e; }
    .ng { color: #b91c1c; }
    .box {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .action-group {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #ccc;
    }
  </style>
</head>
<body>
  <div style="margin-bottom: 20px;">
    <a href="./index.html">Index</a> | <a href="./testauth.html">Auth Test</a>
  </div>
  <h1>Firestore Users Collection Test</h1>
  <p>Tests reading and writing to <code>/users/{uid}</code>.</p>

  <div class="box">
    <h2>Authentication</h2>
    <button id="btnSignIn">Sign In Anonymously</button>
    <button id="btnSignOut">Sign Out</button>
    <span id="status" class="ng">Not Signed In</span>
    <div>UID: <span id="uidDisplay">none</span></div>
  </div>

  <div class="box">
    <h2>Firestore Operations (/users/{uid})</h2>
    <div class="action-group">
      <button id="btnReadDoc" disabled>Read Document</button>
      <button id="btnCreateDoc" disabled>Create Document (if missing)</button>
      <button id="btnUpdateDoc" disabled>Update Document (Timestamp)</button>
    </div>
    <div id="firestoreResult">
        <h3>Result:</h3>
        <pre id="docView">...</pre>
    </div>
  </div>

  <div class="box">
    <h2>Logs</h2>
    <pre id="logView"></pre>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInAnonymously,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    import { firebaseConfig } from "./firebaseConfig.js";

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI Elements
    const statusEl = document.getElementById("status");
    const uidDisplay = document.getElementById("uidDisplay");
    const logView = document.getElementById("logView");
    const docView = document.getElementById("docView");
    
    const btnSignIn = document.getElementById("btnSignIn");
    const btnSignOut = document.getElementById("btnSignOut");
    const btnReadDoc = document.getElementById("btnReadDoc");
    const btnCreateDoc = document.getElementById("btnCreateDoc");
    const btnUpdateDoc = document.getElementById("btnUpdateDoc");

    let currentUser = null;

    function log(message, data) {
      const line = `[${new Date().toLocaleTimeString()}] ${message} ${data ? JSON.stringify(data) : ''}`;
      logView.textContent += line + "\n";
      logView.scrollTop = logView.scrollHeight;
    }

    function updateUI(user) {
      currentUser = user;
      if (user) {
        statusEl.textContent = "Signed In";
        statusEl.className = "ok";
        uidDisplay.textContent = user.uid;
        btnReadDoc.disabled = false;
        btnCreateDoc.disabled = false;
        btnUpdateDoc.disabled = false;
      } else {
        statusEl.textContent = "Not Signed In";
        statusEl.className = "ng";
        uidDisplay.textContent = "none";
        btnReadDoc.disabled = true;
        btnCreateDoc.disabled = true;
        btnUpdateDoc.disabled = true;
        docView.textContent = "...";
      }
    }

    onAuthStateChanged(auth, (user) => {
      updateUI(user);
      if (user) {
        log("User signed in:", user.uid);
      } else {
        log("User signed out");
      }
    });

    btnSignIn.addEventListener("click", () => {
      signInAnonymously(auth).catch(e => log("SignIn Error", e));
    });

    btnSignOut.addEventListener("click", () => {
      signOut(auth).catch(e => log("SignOut Error", e));
    });

    // Firestore Actions
    btnReadDoc.addEventListener("click", async () => {
      if (!currentUser) return;
      log(`Reading /users/${currentUser.uid}...`);
      try {
        const docRef = doc(db, "users", currentUser.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          log("Document found!");
          docView.textContent = JSON.stringify(docSnap.data(), null, 2);
        } else {
          log("Document does not exist.");
          docView.textContent = "(Document does not exist)";
        }
      } catch (e) {
        log("Read Error", e);
        docView.textContent = "Error: " + e.message;
      }
    });

    btnCreateDoc.addEventListener("click", async () => {
        if (!currentUser) return;
        log(`Creating/Overwriting /users/${currentUser.uid}...`);
        try {
            const docRef = doc(db, "users", currentUser.uid);
            const data = {
                createdAt: serverTimestamp(),
                uid: currentUser.uid,
                testData: "Initial creation from test page"
            };
            await setDoc(docRef, data, { merge: true });
            log("Document created/merged successfully.");
            // Read back
            btnReadDoc.click();
        } catch(e) {
            log("Create Error", e);
            docView.textContent = "Error: " + e.message;
        }
    });

    btnUpdateDoc.addEventListener("click", async () => {
        if (!currentUser) return;
        log(`Updating /users/${currentUser.uid}...`);
        try {
            const docRef = doc(db, "users", currentUser.uid);
            await updateDoc(docRef, {
                updatedAt: serverTimestamp(),
                lastUpdateSource: "test-firestore-users.html"
            });
            log("Document updated successfully.");
            // Read back
            btnReadDoc.click();
        } catch(e) {
            log("Update Error", e);
             docView.textContent = "Error: " + e.message;
        }
    });

  </script>
</body>
</html>
