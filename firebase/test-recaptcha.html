<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Firebase App Check Test (reCAPTCHA)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px;
      line-height: 1.4;
    }
    button {
      padding: 8px 14px;
      margin-right: 8px;
      cursor: pointer;
    }
    pre {
      background: #f6f8fa;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .ok { color: #0f766e; }
    .ng { color: #b91c1c; }
    .box {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 16px;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div style="margin-bottom: 20px;">
    <a href="./index.html">Top</a>
  </div>
  <h1>Firebase App Check Test (reCAPTCHA v3)</h1>

  <div class="box">
    <h3>Configuration</h3>
    <p>Please enter your reCAPTCHA v3 Site Key below to initialize App Check.</p>
    <label for="siteKeyInput">reCAPTCHA Site Key:</label>
    <input type="text" id="siteKeyInput" placeholder="Enter your reCAPTCHA v3 site key here">
    <button id="btnInit">Initialize App Check</button>
    <div style="margin-top: 10px;">
        <label><input type="checkbox" id="debugMode"> Enable Debug Token (for localhost)</label>
    </div>
  </div>

  <div class="box">
    <h3>Actions</h3>
    <button id="btnGetToken" disabled>Get App Check Token</button>
  </div>

  <div class="box">
    <h3>Status</h3>
    <div id="status">Not Initialized</div>
  </div>

  <div class="box">
    <h3>Token Result</h3>
    <pre id="tokenView"></pre>
  </div>

  <div class="box">
    <h3>Logs</h3>
    <pre id="logView"></pre>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      initializeAppCheck,
      ReCaptchaEnterpriseProvider,
      getToken
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app-check.js";
    
    import { firebaseConfig } from "./firebaseConfig.js";

    const logView = document.getElementById("logView");
    const tokenView = document.getElementById("tokenView");
    const statusEl = document.getElementById("status");
    const btnInit = document.getElementById("btnInit");
    const btnGetToken = document.getElementById("btnGetToken");
    const siteKeyInput = document.getElementById("siteKeyInput");
    const debugModeCheckbox = document.getElementById("debugMode");

    // Pre-fill site key if found in script tag
    const scriptTag = document.querySelector('script[src*="recaptcha/enterprise.js"]');
    if (scriptTag) {
        const url = new URL(scriptTag.src);
        const key = url.searchParams.get("render");
        if (key && key !== "explicit") {
            siteKeyInput.value = key;
        }
    }

    let appCheck = null;

    function log(message, data) {
      let dataStr = "";
      if (data) {
        if (data instanceof Error) {
            dataStr = " " + JSON.stringify({
                message: data.message,
                name: data.name,
                code: data.code,
                stack: data.stack,
                ...data
            }, Object.getOwnPropertyNames(data), 2);
        } else {
            dataStr = " " + JSON.stringify(data, null, 2);
        }
      }
      const line =
        `[${new Date().toISOString()}] ` +
        message +
        dataStr;
      logView.textContent += line + "\n";
      logView.scrollTop = logView.scrollHeight;
    }

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    log("Firebase App Initialized. Hostname: " + location.hostname);

    // Enable debug token if on localhost (automatically checks)
    
    debugModeCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
            self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;
            log("Debug token enabled (check console for token string)");
        } else {
            self.FIREBASE_APPCHECK_DEBUG_TOKEN = false;
        }
    });

    if (location.hostname === "localhost" || location.hostname === "127.0.0.1" || location.hostname.endsWith(".app.github.dev")) {
        debugModeCheckbox.checked = true;
        self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;
        log("Dev environment detected (" + location.hostname + "): Debug token enabled.");
        log("IMPORTANT: Open your browser developer console (F12) to see the debug token.");
        log("Then add it to Firebase Console > App Check > Apps > Manage debug tokens.");
    }

    btnInit.addEventListener("click", () => {
        const siteKey = siteKeyInput.value.trim();
        if (!siteKey) {
            alert("Please enter a site key");
            return;
        }

        try {
            log("Initializing App Check (Enterprise) with key: " + siteKey);
            
            appCheck = initializeAppCheck(app, {
                provider: new ReCaptchaEnterpriseProvider(siteKey),
                isTokenAutoRefreshEnabled: true
            });
            
            statusEl.textContent = "App Check Initialized";
            statusEl.className = "ok";
            btnGetToken.disabled = false;
            btnInit.disabled = true; // Prevent re-init
            siteKeyInput.disabled = true;
            
            log("App Check initialized successfully");

        } catch (e) {
            log("Error initializing App Check", e);
            statusEl.textContent = "Error: " + e.message;
            statusEl.className = "ng";
        }
    });

    btnGetToken.addEventListener("click", async () => {
        if (!appCheck) return;
        
        try {
            log("Requesting token...");
            // forceRefresh = true to ensure we get a fresh token if needed
            const tokenResult = await getToken(appCheck, /* forceRefresh = */ true);
            
            tokenView.textContent = JSON.stringify({
                token: tokenResult.token,
                expireTimeMillis: tokenResult.expireTimeMillis,
                expireTime: new Date(tokenResult.expireTimeMillis).toLocaleString()
            }, null, 2);
            
            log("Token received successfully");
            
        } catch (e) {
            log("Error getting token", e);
            tokenView.textContent = "Error: " + e.message;
            
            if (e.message.includes("403")) {
                log("HINT: A 403 error usually means your Firebase API Key is restricted.");
                log("Please check Google Cloud Console > APIs & Services > Credentials.");
                log("Ensure the API Key for 'moukaeritaid' allows HTTP referrers from: " + location.origin);
            }
        }
    });

  </script>
</body>
</html>
